#!/home/infocube/fail2ban-bot-env/bin/python3

import telebot
import subprocess
import logging
from datetime import datetime

BOT_TOKEN = '8313901235:AAEzgEGbYe-gqptG2elz_YdHQOeHPWPkbZ0'
ADMIN_CHAT_ID = 815953650
LOG_FILE = '/var/log/fail2ban-bot.log'

logging.basicConfig(
    filename=LOG_FILE,
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)

bot = telebot.TeleBot(BOT_TOKEN)

# ========== COMANDO /start ==========
@bot.message_handler(commands=['start'])
def send_welcome(message):
    welcome_text = """
ğŸ” **Fail2ban Telegram Monitor**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
MODALITÃ€: **READ-ONLY + UNBAN ONLY**

ğŸ“¢ Riceverai notifiche automatiche:
â€¢ ğŸ” Avvio del servizio
â€¢ ğŸš¨ Quando un IP viene bannato
â€¢ âœ… Quando un IP viene sbannato

âœ… Comandi disponibili:
/status - Mostra status di fail2ban
/unban <ip> -j <jail> - Sbanna manualmente un IP
/help - Lista comandi

âš ï¸ Telegram NON esegue ban, solo notifiche
    """
    bot.reply_to(message, welcome_text, parse_mode='Markdown')
    logging.info(f"User {message.chat.id} ha richiesto /start")

# ========== COMANDO /status ==========
@bot.message_handler(commands=['status'])
def send_status(message):
    try:
        result = subprocess.run(
            "sudo fail2ban-client status",
            shell=True,
            capture_output=True,
            text=True,
            timeout=5
        )
        
        if result.returncode == 0:
            status = result.stdout
            response = f"""
ğŸ“Š **FAIL2BAN STATUS**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â° {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
            """
            bot.reply_to(message, response, parse_mode='Markdown')
            logging.info(f"User {message.chat.id} ha richiesto /status")
        else:
            bot.reply_to(message, "âŒ Errore nel recuperare lo status")
            
    except Exception as e:
        bot.reply_to(message, f"âŒ Errore: {str(e)}")
        logging.error(f"Errore /status: {str(e)}")

# ========== COMANDO /unban ==========
@bot.message_handler(commands=['unban'])
def unban_ip(message):
    try:
        # Estrai IP e jail dal messaggio
        # Formato: /unban <ip> -j <jail>
        args = message.text.split()
        
        if len(args) < 4 or args != '-j':
            bot.reply_to(message, """
âŒ Formato errato!

Usa: /unban <ip> -j <jail>

Esempio:
/unban 192.168.1.100 -j sshd
/unban 10.0.0.5 -j nginx-http-auth
            """)
            return
        
        ip = args
        jail = args
        
        # Valida IP (semplice check)
        parts = ip.split('.')
        if len(parts) != 4 or not all(0 <= int(p) <= 255 for p in parts):
            bot.reply_to(message, f"âŒ IP non valido: {ip}")
            return
        
        # Esegui unban
        result = subprocess.run(
            f"sudo fail2ban-client set {jail} unbanip {ip}",
            shell=True,
            capture_output=True,
            text=True,
            timeout=5
        )
        
        if result.returncode == 0:
            response = f"""
âœ… **UNBAN ESEGUITO**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ IP: {ip}
ğŸ“ Jail: {jail}
â° Timestamp: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
            """
            bot.reply_to(message, response, parse_mode='Markdown')
            logging.info(f"User {message.chat.id} ha sbannato {ip} dalla jail {jail}")
        else:
            bot.reply_to(message, f"âŒ Errore nell'unban: {result.stderr}")
            logging.error(f"Errore unban: {result.stderr}")
            
    except Exception as e:
        bot.reply_to(message, f"âŒ Errore: {str(e)}")
        logging.error(f"Errore /unban: {str(e)}")

# ========== COMANDO /help ==========
@bot.message_handler(commands=['help'])
def send_help(message):
    help_text = """
ğŸ“– **Comandi Disponibili**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**/status**
Mostra lo status di fail2ban e tutte le jail

**/unban <ip> -j <jail>**
Sbanna manualmente un IP da una jail
Esempio: `/unban 192.168.1.100 -j sshd`

**/help**
Questo messaggio

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¢ Notifiche Automatiche:
â€¢ ğŸ” Avvio del servizio
â€¢ ğŸš¨ Ban di un IP
â€¢ âœ… Unban di un IP

âš ï¸ MODALITÃ€: **READ-ONLY + UNBAN ONLY**
Telegram riceve solo notifiche e esegue unban
    """
    bot.reply_to(message, help_text, parse_mode='Markdown')

# ========== HANDLER MESSAGGI SCONOSCIUTI ==========
@bot.message_handler(func=lambda message: True)
def echo_all(message):
    response = """
â“ Comando non riconosciuto

Comandi disponibili:
/start - Benvenuto
/status - Status di fail2ban
/unban <ip> -j <jail> - Sbanna manualmente
/help - Lista comandi
    """
    bot.reply_to(message, response)

# ========== MAIN ==========
if __name__ == '__main__':
    logging.info("Bot avviato in MODALITÃ€ READ-ONLY + UNBAN ONLY")
    print("âœ… Bot avviato - ModalitÃ : READ-ONLY + UNBAN ONLY")
    bot.infinity_polling()
